<div>

    <!-- Assessment Completion Banner -->
    @php
    $tabStateService = app(\App\Services\LoanTabStateService::class);
    $loanID = session('currentloanID');
    $isAssessmentCompleted = $tabStateService->isTabCompleted($loanID, 'assessment');
    @endphp

    @if($isAssessmentCompleted)
    <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg shadow-sm">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-green-800">✅ Assessment Completed</h3>
                    <p class="text-sm text-green-600">Loan assessment has been completed and is ready for the next step.</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-green-600">Approved Amount</div>
                <div class="text-lg font-bold text-green-800">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</div>
            </div>
        </div>
    </div>
    @endif

    <div class="mt-2"></div>


    <div class="w-full ">

        @php

        use Illuminate\Support\Facades\DB;
        use Carbon\Carbon;

        // Fetch loan details by loan ID
        $loanID = session('currentloanID');
        $loan = DB::table('loans')->find($loanID);
        $exception_status=false;
        $topUpAmount=0;




        // If loan exists, fetch related client and product details
        if ($loan) {
        $member = DB::table('clients')->where('client_number', $loan->client_number)->first();
        $product = DB::table('loan_sub_products')->where('sub_product_id', $loan->loan_sub_product)->first();
        //$this->approved_loan_value= $loan->principle;
        //$this->approved_term=$loan->tenure;
        // dd($loan->tenure);


        } else {
        $member = null;
        $product = null;
        }

        // Get credit score data from the service (already loaded in component)
        $creditScore = $this->creditScoreData ?? null;
        $creditScoreValue = $creditScore['score'] ?? 500;
        $creditScoreGrade = $creditScore['grade'] ?? 'E';
        $creditScoreRisk = $creditScore['risk_description'] ?? 'Very High Risk - No Data';
        $creditScoreTrend = $creditScore['trend'] ?? 'Stable';
        $creditScoreDate = $creditScore['date'] ?? now();

        // Get client information data from the service (already loaded in component)
        $clientInfo = $this->clientInfoData ?? null;
        $basicInfo = $clientInfo['basic_info'] ?? [];
        $contactInfo = $clientInfo['contact_info'] ?? [];
        $employmentInfo = $clientInfo['employment_info'] ?? [];
        $financialInfo = $clientInfo['financial_info'] ?? [];
        $riskIndicators = $clientInfo['risk_indicators'] ?? [];
        $demographics = $clientInfo['demographics'] ?? [];
        $statusIndicators = $clientInfo['status_indicators'] ?? [];

        // Get product parameters data from the service (already loaded in component)
        $productParams = $this->productParamsData ?? null;
        $productBasicInfo = $productParams['basic_info'] ?? [];
        $productLoanLimits = $productParams['loan_limits'] ?? [];
        $productInterestInfo = $productParams['interest_info'] ?? [];
        $productGracePeriods = $productParams['grace_periods'] ?? [];
        $productFeesAndCharges = $productParams['fees_and_charges'] ?? [];
        $productInsuranceInfo = $productParams['insurance_info'] ?? [];
        $productRepaymentInfo = $productParams['repayment_info'] ?? [];
        $productAccountInfo = $productParams['account_info'] ?? [];
        $productRequirements = $productParams['requirements'] ?? [];
        $productValidation = $productParams['validation'] ?? [];

        // Set the standard retirement age
        $retirementAge = 60; // Adjust based on your requirements

        // Check if date_of_birth is available
        if (!is_null($member->date_of_birth)) {
        // Parse date of birth
        $dob = Carbon::parse($member->date_of_birth);

        // Calculate current age
        $age = $dob->age;

        // Calculate remaining years to retirement
        $yearsToRetirement = $retirementAge - $age;

        // Ensure the remaining years to retirement is not negative
        $yearsToRetirement = max(0, $yearsToRetirement);

        // Calculate the retirement date by adding the remaining years to the date of birth
        $retirementDate = $dob->copy()->addYears($retirementAge);

        // Adjust the day to the 30th or 31st of the retirement month
        $lastDayOfMonth = $retirementDate->endOfMonth()->day;
        $retirementDay = $lastDayOfMonth == 31 ? 31 : 30;
        $retirementDate->day = $retirementDay;

        // Calculate months to retirement (from now to the retirement date)
        $monthsToRetirement = now()->diffInMonths($retirementDate);
        } else {
        $monthsToRetirement = null;
        $retirementDate = null;
        }


        $savings = DB::table('accounts')->where('product_number','20000')->where('client_number',$loan->client_number)->sum('balance');

        $loanCount = Illuminate\Support\Facades\DB::table('loans')->where('client_number',$loan->client_number)->where('status','ACTIVE')->count() + 2;
        //dd($member);
        if ($this->non_permanent_income_taxable <= 270000) {
            $tax=0;
            } elseif ($this->non_permanent_income_taxable <= 520000) {
                $tax=0.08 * ($this->non_permanent_income_taxable - 270000);
                } elseif ($this->non_permanent_income_taxable <= 760000) {
                    $tax=20000 + 0.20 * ($this->non_permanent_income_taxable - 520000);
                    } elseif ($this->non_permanent_income_taxable <= 1000000) {
                        $tax=68000 + 0.25 * ($this->non_permanent_income_taxable - 760000);
                        } else {
                        $tax = 128000 + 0.30 * ($this->non_permanent_income_taxable - 1000000);
                        }
                        //$net_income = 0;
                        //(float)$net_income = ((float)$this->take_home + (float)$this->totalInstallment + $tax) - (float)$this->non_permanent_income_non_taxable - (float)$this->non_permanent_income_taxable;
                        //(float)$net_income = ((float)$this->take_home + (float)$this->non_permanent_income_non_taxable + (float)$this->non_permanent_income_taxable ) - (float)$this->totalInstallment - $tax;
                        @endphp


                        @php
                        $records = \Illuminate\Support\Facades\DB::table('query_responses')
                        ->where('CheckNumber', 111222333)
                        ->get();

                        $totalContracts = 0; // Initialize total contract count
                        $totalContracts2 = 3;
                        $ctotalAmount = 0;
                        // First pass to count the total number of contracts
                        foreach ($records as $record) {
                        $response_data = json_decode($record->response_data, true);
                        $contracts = $response_data['response']['CustomReport']['Contracts']['ContractList']['Contract'] ?? [];



                        if (isset($contracts['Subscriber'])) {
                        $totalContracts += 1; // Single contract object
                        $ctotalAmount += $contracts['TotalAmount']['Value']; // Add to total amount
                        } elseif (is_array($contracts)) {
                        $totalContracts += count($contracts); // Array of contracts
                        foreach ($contracts as $contract) {
                        $ctotalAmount += $contract['TotalAmount']['Value']; // Add to total amount
                        }
                        }


                        }







                        if($this->approved_term){

                        }else{
                        //$this->approved_term = $loan->tenure;
                        $this->approved_term = $product->max_term;
                        }

                        if($this->approved_loan_value){

                        }else{
                        $this->approved_loan_value = $loan->principle;
                        }


                        @endphp

    </div>


    <div class="w-full flex gap-4 p-2">

        <div class="w-1/3">




            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">CREDIT SCORE</p>

            <div id="stability" class="w-full bg-gray-50 rounded rounded-lg shadow-sm   p-1 mb-4">
                <div class="w-full bg-white rounded-lg shadow-sm p-2 flex flex-col items-center justify-center">
                    <canvas id="demo" width="400" height="200"></canvas>
                    <div id="preview-textfield" class="text-center mt-2 font-bold"></div>

                    <!-- Additional Credit Score Information -->
                    <div class="w-full mt-3 text-center">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="font-semibold text-gray-700">Score</div>
                                <div class="text-lg font-bold credit-score-value">
                                    {{ $creditScoreValue }}
                                </div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <div class="font-semibold text-gray-700">Grade</div>
                                <div class="text-lg font-bold credit-score-grade">
                                    {{ $creditScoreGrade }}
                                </div>
                            </div>
                        </div>

                        <div class="mt-2 p-2 bg-gray-50 rounded">
                            <div class="font-semibold text-gray-700 text-xs">Risk Level</div>
                            <div class="text-sm font-medium credit-score-risk">
                                {{ $creditScoreRisk }}
                            </div>
                        </div>

                        <div class="mt-2 p-2 bg-gray-50 rounded">
                            <div class="font-semibold text-gray-700 text-xs">Trend</div>
                            <div class="text-sm font-medium text-gray-600">
                                {{ $creditScoreTrend }}
                            </div>
                        </div>

                        @if(isset($creditScore['reasons']) && is_array($creditScore['reasons']))
                        <div class="mt-2 p-2 bg-gray-50 rounded">
                            <div class="font-semibold text-gray-700 text-xs">Key Factors</div>
                            <div class="text-xs text-gray-600">
                                @foreach(array_slice($creditScore['reasons'], 0, 2) as $reason)
                                <div class="mb-1">• {{ $reason }}</div>
                                @endforeach
                            </div>
                        </div>
                        @endif
                    </div>
                </div>
            </div>



            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">CLIENT'S INFORMATION</p>
            <div id="stability" class="w-full bg-gray-50 rounded rounded-lg shadow-sm   p-1 mb-4">
                <div class="w-full bg-white rounded rounded-lg shadow-sm   p-2 ">

                    <!-- Basic Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Basic Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Full Name:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['full_name'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Client Number:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['client_number'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Date of Birth:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['date_of_birth'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Current Age:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['age'] ?? 'N/A' }} years</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Gender:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['gender'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Marital Status:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['marital_status'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Nationality:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['nationality'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Time to Retirement:</span>
                                <span class="text-slate-900 font-medium">{{ $basicInfo['months_to_retirement'] ?? 'N/A' }} months</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Contact Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Phone Number:</span>
                                <span class="text-slate-900 font-medium">{{ $contactInfo['phone_number'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Email:</span>
                                <span class="text-slate-900 font-medium">{{ $contactInfo['email'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">City:</span>
                                <span class="text-slate-900 font-medium">{{ $contactInfo['city'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Region:</span>
                                <span class="text-slate-900 font-medium">{{ $contactInfo['region'] ?? 'N/A' }}</span>
                            </div>
                        </div>
                        <div class="mt-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Address:</span>
                                <span class="text-slate-900 font-medium text-right">{{ $contactInfo['address'] ?? 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Employment Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Employment Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Employment Status:</span>
                                <span class="text-slate-900 font-medium">{{ $employmentInfo['employment_status'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Occupation:</span>
                                <span class="text-slate-900 font-medium">{{ $employmentInfo['occupation'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Employer/Business:</span>
                                <span class="text-slate-900 font-medium">{{ $employmentInfo['employer_name'] ?? $employmentInfo['business_name'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Education Level:</span>
                                <span class="text-slate-900 font-medium">{{ $employmentInfo['education_level'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Basic Salary:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($employmentInfo['basic_salary'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Annual Income:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($employmentInfo['annual_income'] ?? 0, 2) }} TZS</span>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Financial Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Savings:</span>
                                <span class="text-slate-900 font-semibold">{{ number_format($financialInfo['savings_balance'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Active Loans:</span>
                                <span class="text-slate-900 font-medium">{{ $financialInfo['active_loans_count'] ?? 0 }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Total Loan Balance:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($financialInfo['total_loan_balance'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Shares:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($financialInfo['shares'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Monthly Expenses:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($financialInfo['monthly_expenses'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Available Income:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($financialInfo['income_available'] ?? 0, 2) }} TZS</span>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Indicators Section -->
                    @if(!empty($riskIndicators))
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Risk Indicators</h4>
                        <div class="space-y-1">
                            @foreach($riskIndicators as $indicator)
                            <div class="flex items-center text-xs">
                                <span class="w-2 h-2 rounded-full mr-2 
                                    @if($indicator['level'] === 'high') bg-red-500 
                                    @elseif($indicator['level'] === 'medium') bg-yellow-500 
                                    @else bg-green-500 @endif">
                                </span>
                                <span class="text-slate-700">{{ $indicator['message'] }}</span>
                            </div>
                            @endforeach
                        </div>
                    </div>
                    @endif

                    <!-- Status Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Status Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Member Category:</span>
                                <span class="text-slate-900 font-medium">{{ $statusIndicators['member_category'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Client Status:</span>
                                <span class="text-slate-900 font-medium">{{ $statusIndicators['client_status'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Registration Date:</span>
                                <span class="text-slate-900 font-medium">{{ $statusIndicators['registration_date'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Terms Accepted:</span>
                                <span class="text-slate-900 font-medium">{{ $statusIndicators['accept_terms'] ? 'Yes' : 'No' }}</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <hr class="boder-b-0 my-6" />

            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">PRODUCT PARAMETERS</p>
            <div id="stability" class="w-full bg-gray-50 rounded rounded-lg shadow-sm   p-1 mb-4">
                <div class="w-full bg-white rounded rounded-lg shadow-sm   p-2 ">

                    <!-- Basic Product Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Basic Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Product Name:</span>
                                <span class="text-slate-900 font-medium">{{ $productBasicInfo['sub_product_name'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Product ID:</span>
                                <span class="text-slate-900 font-medium">{{ $productBasicInfo['sub_product_id'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Status:</span>
                                <span class="text-slate-900 font-medium">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        @if(($productBasicInfo['status'] ?? '') === 'ACTIVE') bg-green-100 text-green-800 
                                        @else bg-red-100 text-red-800 @endif">
                                        {{ $productBasicInfo['status'] ?? 'N/A' }}
                                    </span>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Currency:</span>
                                <span class="text-slate-900 font-medium">{{ $productBasicInfo['currency'] ?? 'TZS' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Limits Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Loan Limits</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Minimum Amount:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($productLoanLimits['min_amount'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Maximum Amount:</span>
                                <span class="text-slate-900 font-semibold">{{ number_format($productLoanLimits['max_amount'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Minimum Term:</span>
                                <span class="text-slate-900 font-medium">{{ $productLoanLimits['min_term'] ?? 0 }} months</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Maximum Term:</span>
                                <span class="text-slate-900 font-semibold">{{ $productLoanLimits['max_term'] ?? 0 }} months</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Loan Multiplier:</span>
                                <span class="text-slate-900 font-medium">{{ $productLoanLimits['loan_multiplier'] ?? 0 }}x</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">LTV Ratio:</span>
                                <span class="text-slate-900 font-medium">{{ $productLoanLimits['ltv'] ?? 0 }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Credit Score Limit:</span>
                                <span class="text-slate-900 font-medium">{{ $productLoanLimits['score_limit'] ?? 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Interest Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Interest Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Annual Interest Rate:</span>
                                <span class="text-slate-900 font-semibold">{{ number_format($productInterestInfo['interest_rate'] ?? 0, 2) }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Monthly Interest Rate:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($productInterestInfo['monthly_rate'] ?? 0, 4) }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Interest Method:</span>
                                <span class="text-slate-900 font-medium">{{ $productInterestInfo['interest_method'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Amortization Method:</span>
                                <span class="text-slate-900 font-medium">{{ $productInterestInfo['amortization_method'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Days in Year:</span>
                                <span class="text-slate-900 font-medium">{{ $productInterestInfo['days_in_year'] ?? 365 }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Days in Month:</span>
                                <span class="text-slate-900 font-medium">{{ $productInterestInfo['days_in_month'] ?? 30 }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Grace Periods Section -->
                    @if($productGracePeriods['has_grace_period'] ?? false)
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Grace Periods</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Principal Grace Period:</span>
                                <span class="text-slate-900 font-medium">{{ $productGracePeriods['principle_grace_period'] ?? 0 }} months</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Interest Grace Period:</span>
                                <span class="text-slate-900 font-medium">{{ $productGracePeriods['interest_grace_period'] ?? 0 }} months</span>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Fees and Charges Section -->
                    @if(!empty($productFeesAndCharges['charges']))
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Fees and Charges</h4>
                        <div class="space-y-2">
                            @foreach($productFeesAndCharges['charges'] as $charge)
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex-1">
                                    <div class="font-medium text-slate-900">{{ $charge['name'] }}</div>
                                    <div class="text-slate-500 text-xs">{{ $charge['type'] }} - {{ $charge['description'] }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-slate-900">{{ number_format($charge['amount'], 2) }} TZS</div>
                                    <div class="text-slate-500 text-xs">
                                        @if($charge['type'] === 'Percent')
                                        {{ number_format($charge['value'], 2) }}%
                                        @else
                                        Fixed
                                        @endif
                                    </div>
                                </div>
                            </div>
                            @endforeach
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between font-semibold">
                                    <span class="text-slate-700">Total Charges:</span>
                                    <span class="text-slate-900">{{ number_format($productFeesAndCharges['total_charges'] ?? 0, 2) }} TZS</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Insurance Information Section -->
                    @if(!empty($productInsuranceInfo['insurances']))
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Insurance</h4>
                        <div class="space-y-2">
                            @foreach($productInsuranceInfo['insurances'] as $insurance)
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex-1">
                                    <div class="font-medium text-slate-900">{{ $insurance['name'] }}</div>
                                    <div class="text-slate-500 text-xs">{{ $insurance['type'] }} - {{ $insurance['description'] }}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-semibold text-slate-900">{{ number_format($insurance['amount'], 2) }} TZS</div>
                                    <div class="text-slate-500 text-xs">
                                        @if($insurance['type'] === 'Percent')
                                        {{ number_format($insurance['value'], 2) }}%
                                        @else
                                        Fixed
                                        @endif
                                    </div>
                                </div>
                            </div>
                            @endforeach
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between font-semibold">
                                    <span class="text-slate-700">Total Insurance:</span>
                                    <span class="text-slate-900">{{ number_format($productInsuranceInfo['total_insurance'] ?? 0, 2) }} TZS</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Repayment Information Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Repayment Information</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Repayment Strategy:</span>
                                <span class="text-slate-900 font-medium">{{ $productRepaymentInfo['repayment_strategy'] ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Repayment Frequency:</span>
                                <span class="text-slate-900 font-medium">{{ $productRepaymentInfo['repayment_frequency'] ?? 'Monthly' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Inactivity Period:</span>
                                <span class="text-slate-900 font-medium">{{ $productRepaymentInfo['inactivity_period'] ?? 0 }} days</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Penalty Value:</span>
                                <span class="text-slate-900 font-medium">{{ number_format($productFeesAndCharges['penalty_value'] ?? 0, 2) }} TZS</span>
                            </div>
                        </div>
                    </div>

                    <!-- Product Requirements Section -->
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Product Requirements</h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-slate-400">Requires Approval:</span>
                                <span class="text-slate-900 font-medium">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        @if(($productRequirements['requires_approval'] ?? '') === 'Yes') bg-blue-100 text-blue-800 
                                        @else bg-gray-100 text-gray-800 @endif">
                                        {{ $productRequirements['requires_approval'] ?? 'No' }}
                                    </span>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Send Notifications:</span>
                                <span class="text-slate-900 font-medium">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        @if(($productRequirements['send_notifications'] ?? '') === 'Yes') bg-green-100 text-green-800 
                                        @else bg-gray-100 text-gray-800 @endif">
                                        {{ $productRequirements['send_notifications'] ?? 'No' }}
                                    </span>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Require Member Image:</span>
                                <span class="text-slate-900 font-medium">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        @if(($productRequirements['require_image_member'] ?? '') === 'Yes') bg-yellow-100 text-yellow-800 
                                        @else bg-gray-100 text-gray-800 @endif">
                                        {{ $productRequirements['require_image_member'] ?? 'No' }}
                                    </span>
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-400">Require ID Image:</span>
                                <span class="text-slate-900 font-medium">
                                    <span class="px-2 py-1 text-xs rounded-full 
                                        @if(($productRequirements['require_image_id'] ?? '') === 'Yes') bg-yellow-100 text-yellow-800 
                                        @else bg-gray-100 text-gray-800 @endif">
                                        {{ $productRequirements['require_image_id'] ?? 'No' }}
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Validation Section -->
                    @if(!empty($productValidation))
                    <div class="mb-4">
                        <h4 class="text-xs font-semibold text-gray-700 mb-2 border-b pb-1">Parameter Validation</h4>
                        <div class="space-y-2">
                            @foreach($productValidation as $validation)
                            <div class="flex items-center text-xs">
                                <span class="w-2 h-2 rounded-full mr-2 
                                    @if($validation['level'] === 'error') bg-red-500 
                                    @elseif($validation['level'] === 'warning') bg-yellow-500 
                                    @else bg-green-500 @endif">
                                </span>
                                <span class="text-slate-700">{{ $validation['message'] }}</span>
                            </div>
                            @endforeach
                        </div>
                    </div>
                    @endif

                </div>
            </div>

            <hr class="boder-b-0 my-6" />

            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">EXCEPTIONS</p>
            <div id="stability" class="w-full bg-gray-50 rounded rounded-lg shadow-sm   p-1 mb-4">
                <div class="w-full bg-white rounded rounded-lg shadow-sm  p-2 ">

                    <!-- Exception Summary -->
                    @if(isset($exceptionData['summary']))
                    <div class="mb-4 p-3 rounded-lg 
                        @if($exceptionData['summary']['overall_status'] === 'APPROVED') bg-green-50 border border-green-200
                        @elseif($exceptionData['summary']['overall_status'] === 'REJECTED') bg-red-50 border border-red-200
                        @else bg-yellow-50 border border-yellow-200 @endif">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-2 
                                    @if($exceptionData['summary']['overall_status'] === 'APPROVED') bg-green-500
                                    @elseif($exceptionData['summary']['overall_status'] === 'REJECTED') bg-red-500
                                    @else bg-yellow-500 @endif">
                                </div>
                                <span class="font-semibold text-sm 
                                        @if($exceptionData['summary']['overall_status'] === 'APPROVED') text-green-800
                                    @elseif($exceptionData['summary']['overall_status'] === 'REJECTED') text-red-800
                                        @else text-yellow-800 @endif">
                                    Overall Status: {{ $exceptionData['summary']['overall_status'] }}
                                </span>
                            </div>
                            <div class="text-xs text-gray-600">
                                {{ $exceptionData['summary']['passed_checks'] }}/{{ $exceptionData['summary']['total_checks'] }} checks passed
                            </div>
                        </div>
                        @if($exceptionData['summary']['high_severity'] > 0 || $exceptionData['summary']['medium_severity'] > 0)
                        <div class="mt-2 text-xs">
                            @if($exceptionData['summary']['high_severity'] > 0)
                            <span class="text-red-600 font-medium">{{ $exceptionData['summary']['high_severity'] }} high severity issues</span>
                            @endif
                            @if($exceptionData['summary']['medium_severity'] > 0)
                            <span class="text-yellow-600 font-medium">{{ $exceptionData['summary']['medium_severity'] }} medium severity issues</span>
                            @endif
                        </div>
                        @endif
                    </div>
                    @endif

                    <!-- Exception Details -->
                    <div class="space-y-3">
                        @if(isset($exceptionData['loan_amount']))
                        <div class="border border-gray-200 rounded-lg p-3 
                            @if($exceptionData['loan_amount']['is_exceeded'] ?? false) bg-red-50 border-red-200
                            @else bg-green-50 border-green-200 @endif">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm text-gray-900">{{ $exceptionData['loan_amount']['name'] ?? 'Loan Amount Check' }}</h4>
                                    <p class="text-xs text-gray-600 mt-1">{{ $exceptionData['loan_amount']['description'] ?? 'Checking loan amount limits' }}</p>
                                    @if($exceptionData['loan_amount']['recommendation'] ?? false)
                                    <p class="text-xs text-blue-600 mt-1 font-medium">💡 {{ $exceptionData['loan_amount']['recommendation'] }}</p>
                                    @endif
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">
                                        <div>Limit: {{ number_format($exceptionData['loan_amount']['limit'] ?? 0, 2) }} {{ $exceptionData['loan_amount']['unit'] ?? 'TZS' }}</div>
                                        <div>Given: {{ number_format($exceptionData['loan_amount']['given'] ?? 0, 2) }} {{ $exceptionData['loan_amount']['unit'] ?? 'TZS' }}</div>
                                        @if(($exceptionData['loan_amount']['percentage'] ?? 0) > 0)
                                        <div class="text-xs {{ ($exceptionData['loan_amount']['is_exceeded'] ?? false) ? 'text-red-600' : 'text-green-600' }}">
                                            {{ $exceptionData['loan_amount']['percentage'] }}% of limit
                                        </div>
                                        @endif
                                    </div>
                                    <div class="mt-1">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($exceptionData['loan_amount']['is_exceeded'] ?? false) bg-red-100 text-red-800
                                            @else bg-green-100 text-green-800 @endif">
                                            {{ $exceptionData['loan_amount']['status'] ?? 'PENDING' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @endif

                        @if(isset($exceptionData['term']))
                        <div class="border border-gray-200 rounded-lg p-3 
                            @if($exceptionData['term']['is_exceeded'] ?? false) bg-red-50 border-red-200
                            @else bg-green-50 border-green-200 @endif">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm text-gray-900">{{ $exceptionData['term']['name'] ?? 'Term Check' }}</h4>
                                    <p class="text-xs text-gray-600 mt-1">{{ $exceptionData['term']['description'] ?? 'Checking loan term limits' }}</p>
                                    @if($exceptionData['term']['recommendation'] ?? false)
                                    <p class="text-xs text-blue-600 mt-1 font-medium">💡 {{ $exceptionData['term']['recommendation'] }}</p>
                                    @endif
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">
                                        <div>Limit: {{ $exceptionData['term']['limit'] ?? 0 }} {{ $exceptionData['term']['unit'] ?? 'months' }}</div>
                                        <div>Given: {{ $exceptionData['term']['given'] ?? 0 }} {{ $exceptionData['term']['unit'] ?? 'months' }}</div>
                                        @if(($exceptionData['term']['percentage'] ?? 0) > 0)
                                        <div class="text-xs {{ ($exceptionData['term']['is_exceeded'] ?? false) ? 'text-red-600' : 'text-green-600' }}">
                                            {{ $exceptionData['term']['percentage'] }}% of limit
                                        </div>
                                        @endif
                                    </div>
                                    <div class="mt-1">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($exceptionData['term']['is_exceeded'] ?? false) bg-red-100 text-red-800
                                            @else bg-green-100 text-green-800 @endif">
                                            {{ $exceptionData['term']['status'] ?? 'PENDING' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @endif

                        @if(isset($exceptionData['credit_score']))
                        <div class="border border-gray-200 rounded-lg p-3 
                            @if($exceptionData['credit_score']['is_exceeded'] ?? false) bg-red-50 border-red-200
                            @else bg-green-50 border-green-200 @endif">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm text-gray-900">{{ $exceptionData['credit_score']['name'] ?? 'Credit Score Check' }}</h4>
                                    <p class="text-xs text-gray-600 mt-1">{{ $exceptionData['credit_score']['description'] ?? 'Checking credit score requirements' }}</p>
                                    @if($exceptionData['credit_score']['recommendation'] ?? false)
                                    <p class="text-xs text-blue-600 mt-1 font-medium">💡 {{ $exceptionData['credit_score']['recommendation'] }}</p>
                                    @endif
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">
                                        <div>Limit: {{ $exceptionData['credit_score']['limit'] ?? 0 }} {{ $exceptionData['credit_score']['unit'] ?? 'score' }}</div>
                                        <div>Given: {{ $exceptionData['credit_score']['given'] ?? 0 }} (Grade: {{ $exceptionData['credit_score']['grade'] ?? 'N/A' }})</div>
                                        @if(($exceptionData['credit_score']['percentage'] ?? 0) > 0)
                                        <div class="text-xs {{ ($exceptionData['credit_score']['is_exceeded'] ?? false) ? 'text-red-600' : 'text-green-600' }}">
                                            {{ $exceptionData['credit_score']['percentage'] }}% of limit
                                        </div>
                                        @endif
                                    </div>
                                    <div class="mt-1">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($exceptionData['credit_score']['is_exceeded'] ?? false) bg-red-100 text-red-800
                                            @else bg-green-100 text-green-800 @endif">
                                            {{ $exceptionData['credit_score']['status'] ?? 'PENDING' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @endif

                        @if(isset($exceptionData['salary_installment']))
                        <div class="border border-gray-200 rounded-lg p-3 
                            @if($exceptionData['salary_installment']['is_exceeded'] ?? false) bg-red-50 border-red-200
                            @else bg-green-50 border-green-200 @endif">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm text-gray-900">{{ $exceptionData['salary_installment']['name'] ?? 'Salary/Installment Check' }}</h4>
                                    <p class="text-xs text-gray-600 mt-1">{{ $exceptionData['salary_installment']['description'] ?? 'Checking salary to installment ratio' }}</p>
                                    @if($exceptionData['salary_installment']['recommendation'] ?? false)
                                    <p class="text-xs text-blue-600 mt-1 font-medium">💡 {{ $exceptionData['salary_installment']['recommendation'] }}</p>
                                    @endif
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">
                                        <div>Take Home: {{ number_format($exceptionData['salary_installment']['take_home'] ?? 0, 2) }} {{ $exceptionData['salary_installment']['unit'] ?? 'TZS' }}</div>
                                        <div>Limit: {{ number_format($exceptionData['salary_installment']['limit'] ?? 0, 2) }} {{ $exceptionData['salary_installment']['unit'] ?? 'TZS' }}</div>
                                        <div>Given: {{ number_format($exceptionData['salary_installment']['given'] ?? 0, 2) }} {{ $exceptionData['salary_installment']['unit'] ?? 'TZS' }}</div>
                                        @if(($exceptionData['salary_installment']['percentage'] ?? 0) > 0)
                                        <div class="text-xs {{ ($exceptionData['salary_installment']['is_exceeded'] ?? false) ? 'text-red-600' : 'text-green-600' }}">
                                            {{ $exceptionData['salary_installment']['percentage'] }}% of limit
                                        </div>
                                        @endif
                                    </div>
                                    <div class="mt-1">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($exceptionData['salary_installment']['is_exceeded'] ?? false) bg-red-100 text-red-800
                                            @else bg-green-100 text-green-800 @endif">
                                            {{ $exceptionData['salary_installment']['status'] ?? 'PENDING' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @endif

                        @if(isset($exceptionData['collateral']))
                        <div class="border border-gray-200 rounded-lg p-3 
                            @if($exceptionData['collateral']['is_exceeded'] ?? false) bg-red-50 border-red-200
                            @else bg-green-50 border-green-200 @endif">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-sm text-gray-900">{{ $exceptionData['collateral']['name'] ?? 'Collateral Check' }}</h4>
                                    <p class="text-xs text-gray-600 mt-1">{{ $exceptionData['collateral']['description'] ?? 'Checking collateral requirements' }}</p>
                                    @if($exceptionData['collateral']['recommendation'] ?? false)
                                    <p class="text-xs text-blue-600 mt-1 font-medium">💡 {{ $exceptionData['collateral']['recommendation'] }}</p>
                                    @endif
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-600">
                                        @if(($exceptionData['collateral']['unit'] ?? '') === '%')
                                        <div>Limit: {{ $exceptionData['collateral']['limit'] ?? 0 }}%</div>
                                        <div>Given: {{ number_format($exceptionData['collateral']['given'] ?? 0, 2) }}%</div>
                                        @else
                                        <div>Limit: {{ number_format($exceptionData['collateral']['limit'] ?? 0, 2) }} {{ $exceptionData['collateral']['unit'] ?? 'TZS' }}</div>
                                        <div>Given: {{ number_format($exceptionData['collateral']['given'] ?? 0, 2) }} {{ $exceptionData['collateral']['unit'] ?? 'TZS' }}</div>
                                        @endif
                                        @if(($exceptionData['collateral']['percentage'] ?? 0) > 0)
                                        <div class="text-xs {{ ($exceptionData['collateral']['is_exceeded'] ?? false) ? 'text-red-600' : 'text-green-600' }}">
                                            {{ $exceptionData['collateral']['percentage'] }}% of limit
                                        </div>
                                        @endif
                                    </div>
                                    <div class="mt-1">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($exceptionData['collateral']['is_exceeded'] ?? false) bg-red-100 text-red-800
                                            @else bg-green-100 text-green-800 @endif">
                                            {{ $exceptionData['collateral']['status'] ?? 'PENDING' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @endif
                    </div>

                    <!-- Action Buttons -->
                    @if($showActionButtons && isset($exceptionData['summary']) && !in_array($loan->status ?? '', ['PENDING_DISBURSEMENT', 'PENDING_EXCEPTION_APPROVAL', 'APPROVED', 'DISBURSED']))
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-3 mb-4">
                                        @if($exceptionData['summary']['can_approve'] ?? false)
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <span class="text-green-800 font-semibold text-lg">✅ Loan Assessment Complete</span>
                                        </div>
                                        @elseif($exceptionData['summary']['requires_exception'] ?? false)
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <span class="text-yellow-800 font-semibold text-lg">⚠️ Requires Exception Approval</span>
                                        </div>
                                        @else
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                                </svg>
                                            </div>
                                            <span class="text-red-800 font-semibold text-lg">❌ Loan Does Not Meet Requirements</span>
                                        </div>
                                        @endif
                                    </div>

                                    <div class="text-base text-gray-700 leading-relaxed">
                                        @if($exceptionData['summary']['can_approve'] ?? false)
                                        <p class="mb-2">All loan requirements have been met. The loan is ready for disbursement approval.</p>
                                        <p class="text-sm text-gray-600">Approved Amount: <span class="font-semibold text-green-700">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span></p>
                                        @elseif($exceptionData['summary']['requires_exception'] ?? false)
                                        <p class="mb-2">Some loan parameters exceed standard limits but can be approved with exceptions.</p>
                                        <p class="text-sm text-gray-600">Requested Amount: <span class="font-semibold text-yellow-700">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span></p>
                                        @else
                                        <p class="mb-2">Critical loan requirements are not met. The loan cannot be approved at this time.</p>
                                        <p class="text-sm text-gray-600">Requested Amount: <span class="font-semibold text-red-700">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span></p>
                                        @endif
                                    </div>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-3 w-full xl:w-auto">
                                    @if(in_array($loan->status ?? '', ['PENDING_APPROVAL', 'PENDING_EXCEPTION_APPROVAL']))
                                    <!-- Status-specific buttons for pending approval loans -->
                                    @if($loan->status === 'PENDING_APPROVAL')
                                    <div class="flex flex-col sm:flex-row gap-3 w-full">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex-1">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="text-sm font-semibold text-blue-800">⏳ Pending Approval</h4>
                                                    <p class="text-xs text-blue-600">Loan is awaiting approval from the approval team.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <button wire:click="withdrawApprovalRequest()"
                                            wire:loading.attr="disabled"
                                            wire:loading.class="opacity-50 cursor-not-allowed"
                                            class="inline-flex items-center justify-center px-6 py-3 bg-orange-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-orange-700 focus:bg-orange-700 active:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                            <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                            <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span wire:loading.remove>Withdraw Request</span>
                                            <span wire:loading>Withdrawing...</span>
                                        </button>
                                    </div>
                                    @elseif($loan->status === 'PENDING_EXCEPTION_APPROVAL')
                                    <div class="flex flex-col sm:flex-row gap-3 w-full">
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex-1">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h4 class="text-sm font-semibold text-yellow-800">⚠️ Pending Exception Approval</h4>
                                                    <p class="text-xs text-yellow-600">Loan is awaiting exception approval from the approval team.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <button wire:click="withdrawExceptionRequest()"
                                            wire:loading.attr="disabled"
                                            wire:loading.class="opacity-50 cursor-not-allowed"
                                            class="inline-flex items-center justify-center px-6 py-3 bg-orange-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-orange-700 focus:bg-orange-700 active:bg-orange-800 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                            <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                            <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span wire:loading.remove>Withdraw Request</span>
                                            <span wire:loading>Withdrawing...</span>
                                        </button>
                                    </div>
                                    @endif
                                    @elseif(isset($exceptionData['summary']['can_approve']) && ($exceptionData['summary']['can_approve'] ?? false))
                                    <button wire:click="sendForApproval()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-green-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-green-700 focus:bg-green-700 active:bg-green-800 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Send for Disbursement</span>
                                        <span wire:loading>Sending...</span>
                                    </button>

                                    <button wire:click="saveAsDraft()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-gray-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-gray-700 focus:bg-gray-700 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Save as Draft</span>
                                        <span wire:loading>Saving...</span>
                                    </button>

                                    @elseif(isset($exceptionData['summary']['requires_exception']) && ($exceptionData['summary']['requires_exception'] ?? false))
                                    <button wire:click="sendForApprovalWithExceptions()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-yellow-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-yellow-700 focus:bg-yellow-700 active:bg-yellow-800 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Request Exception Approval</span>
                                        <span wire:loading>Requesting...</span>
                                    </button>

                                    <button wire:click="saveAsDraft()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-gray-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-gray-700 focus:bg-gray-700 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Save as Draft</span>
                                        <span wire:loading>Saving...</span>
                                    </button>

                                    @else
                                    <button wire:click="declineLoan()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-red-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-red-700 focus:bg-red-700 active:bg-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Decline Loan</span>
                                        <span wire:loading>Declining...</span>
                                    </button>

                                    <button wire:click="requestAdditionalDocuments()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-purple-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-purple-700 focus:bg-purple-700 active:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Request Documents</span>
                                        <span wire:loading>Requesting...</span>
                                    </button>

                                    <button wire:click="saveAsDraft()"
                                        wire:loading.attr="disabled"
                                        wire:loading.class="opacity-50 cursor-not-allowed"
                                        class="inline-flex items-center justify-center px-6 py-3 bg-gray-600 border border-transparent rounded-lg font-semibold text-sm text-white uppercase tracking-wide hover:bg-gray-700 focus:bg-gray-700 active:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 shadow-sm hover:shadow-md min-w-[200px] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg wire:loading.remove class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                        </svg>
                                        <svg wire:loading class="animate-spin w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span wire:loading.remove>Save as Draft</span>
                                        <span wire:loading>Saving...</span>
                                    </button>
                                    @endif
                                </div>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Loan Status Information -->
                    @if(in_array($loan->status ?? '', ['PENDING_DISBURSEMENT', 'PENDING_EXCEPTION_APPROVAL', 'APPROVED', 'DISBURSED', 'REJECTED']))
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200 shadow-sm">
                            <div class="flex items-center space-x-3 mb-4">
                                @if($loan->status === 'PENDING_DISBURSEMENT')
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-800">⏳ Pending Disbursement Approval</h3>
                                    <p class="text-sm text-blue-600">Your loan has been sent for disbursement approval. Please wait for the approval team to review your request.</p>
                                </div>
                                @elseif($loan->status === 'PENDING_EXCEPTION_APPROVAL')
                                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-yellow-800">⚠️ Pending Exception Approval</h3>
                                    <p class="text-sm text-yellow-600">Your loan has been sent for exception approval. The approval team will review the exceptions and make a decision.</p>
                                </div>
                                @elseif($loan->status === 'APPROVED')
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-green-800">✅ Loan Approved</h3>
                                    <p class="text-sm text-green-600">Congratulations! Your loan has been approved and is ready for disbursement.</p>
                                </div>
                                @elseif($loan->status === 'DISBURSED')
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-green-800">💰 Loan Disbursed</h3>
                                    <p class="text-sm text-green-600">Your loan has been successfully disbursed to your account.</p>
                                </div>
                                @elseif($loan->status === 'REJECTED')
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-red-800">❌ Loan Rejected</h3>
                                    <p class="text-sm text-red-600">Your loan has been rejected by the approval team. You can modify the loan parameters and resubmit.</p>
                                </div>
                                @endif
                            </div>

                            @if($loan->status === 'REJECTED')
                            <div class="mt-4 pt-4 border-t border-blue-200">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button wire:click="$set('showActionButtons', true)"
                                        class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 border border-transparent rounded-lg font-medium text-sm text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Modify & Resubmit
                                    </button>

                                    <button onclick="window.location.reload()"
                                        class="inline-flex items-center justify-center px-4 py-2 bg-gray-600 border border-transparent rounded-lg font-medium text-sm text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Refresh Page
                                    </button>
                                </div>
                            </div>
                            @endif
                        </div>
                    </div>
                    @endif

                    <!-- Action Completion Message -->
                    @if($actionCompleted)
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl border border-green-200 shadow-sm">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-green-800">
                                        @if($actionType === 'approval_sent')
                                        ✅ Approval Request Sent
                                        @elseif($actionType === 'exception_approval_sent')
                                        ⚠️ Exception Approval Requested
                                        @elseif($actionType === 'loan_declined')
                                        ❌ Loan Declined
                                        @elseif($actionType === 'draft_saved')
                                        💾 Draft Saved
                                        @elseif($actionType === 'documents_requested')
                                        📄 Documents Requested
                                        @else
                                        ✅ Action Completed
                                        @endif
                                    </h3>
                                </div>
                            </div>

                            <div class="text-base text-gray-700 leading-relaxed mb-4">
                                {{ $actionMessage }}
                            </div>

                            <div class="flex flex-col sm:flex-row gap-3">
                                <button wire:click="$set('actionCompleted', false); $set('showActionButtons', true)"
                                    class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 border border-transparent rounded-lg font-medium text-sm text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    Reset Action
                                </button>

                                <button onclick="window.location.reload()"
                                    class="inline-flex items-center justify-center px-4 py-2 bg-gray-600 border border-transparent rounded-lg font-medium text-sm text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                                    </svg>
                                    Refresh Page
                                </button>
                            </div>
                        </div>
                    </div>
                    @endif

                </div>
            </div>






        </div>


        <div class="w-2/3">




            @if($loan->loan_type_2=="New" || $loan->loan_type_2=="TopUp")
            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">
                @if($loan->loan_type_2=="TopUp")
                SELECT LOAN TO TOP-UP
                @else
                NBC SACOSS LOANS
                @endif
            </p>
            <div id="stability" class="w-full bg-gray-50 rounded rounded-lg shadow-sm p-1 mb-4">
                <div class="w-full bg-white rounded rounded-lg shadow-sm p-2">

                    <!-- TopUp Specific Instructions -->
                    @if($loan->loan_type_2=="TopUp")
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <h4 class="text-sm font-semibold text-blue-900">Top-Up Loan Instructions</h4>
                                <p class="text-xs text-blue-700">Select an existing active loan. The outstanding balance will be deducted from your new loan amount.</p>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Loans Summary -->
                    @if(isset($nbcLoansData['summary']))
                    <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="grid grid-cols-4 gap-4 text-xs">
                            <div class="text-center">
                                <div class="font-semibold text-blue-900">{{ $nbcLoansData['summary']['total_loans'] }}</div>
                                <div class="text-blue-600">Total Loans</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-green-900">{{ $nbcLoansData['summary']['active_loans'] }}</div>
                                <div class="text-green-600">Active</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-red-900">{{ $nbcLoansData['summary']['overdue_loans'] }}</div>
                                <div class="text-red-600">Overdue</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-gray-900">{{ number_format($nbcLoansData['summary']['total_balance'], 2) }}</div>
                                <div class="text-gray-600">Total Balance (TZS)</div>
                            </div>
                        </div>
                    </div>
                    @endif

                    <!-- Loans Table -->
                    @if(isset($nbcLoansData['loans']) && count($nbcLoansData['loans']) > 0)
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-200">
                                    <th class="text-left p-2 font-medium text-gray-700">Product Name</th>
                                    <th class="text-right p-2 font-medium text-gray-700">Loan Balance</th>
                                    <th class="text-right p-2 font-medium text-gray-700">Monthly Installment</th>
                                    <th class="text-center p-2 font-medium text-gray-700">Status</th>
                                    <th class="text-center p-2 font-medium text-gray-700">Risk Level</th>
                                    <th class="text-center p-2 font-medium text-gray-700">Select</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach($nbcLoansData['loans'] as $nbcLoan)
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="p-2">
                                        <div class="font-medium text-gray-900">{{ $nbcLoan['product_name'] }}</div>
                                        <div class="text-xs text-gray-500">ID: {{ $nbcLoan['loan_id'] }}</div>
                                    </td>
                                    <td class="p-2 text-right">
                                        <div class="font-semibold text-gray-900">{{ number_format($nbcLoan['account_balance'], 2) }} TZS</div>
                                        <div class="text-xs text-gray-500">{{ $nbcLoan['loan_account_number'] }}</div>
                                        @if($nbcLoan['sub_account_balance'] > 0)
                                        <div class="text-xs text-blue-600">Top-up: {{ number_format($nbcLoan['sub_account_balance'], 2) }} TZS</div>
                                        @endif
                                    </td>
                                    <td class="p-2 text-right">
                                        <div class="font-medium text-gray-900">{{ number_format($nbcLoan['installment'], 2) }} TZS</div>
                                        <div class="text-xs text-gray-500">{{ $nbcLoan['payment_frequency'] }}</div>
                                    </td>
                                    <td class="p-2 text-center">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($nbcLoan['loan_status'] === 'Active') bg-green-100 text-green-800
                                            @elseif($nbcLoan['loan_status'] === 'Overdue') bg-yellow-100 text-yellow-800
                                            @elseif($nbcLoan['loan_status'] === 'Seriously Overdue') bg-red-100 text-red-800
                                            @elseif($nbcLoan['loan_status'] === 'Late') bg-orange-100 text-orange-800
                                            @elseif($nbcLoan['loan_status'] === 'Paid Off') bg-blue-100 text-blue-800
                                            @else bg-gray-100 text-gray-800 @endif">
                                            {{ $nbcLoan['loan_status'] }}
                                        </span>
                                        @if($nbcLoan['days_overdue'] > 0)
                                        <div class="text-xs text-red-600 mt-1">{{ $nbcLoan['days_overdue'] }} days overdue</div>
                                        @endif
                                    </td>
                                    <td class="p-2 text-center">
                                        <span class="px-2 py-1 text-xs rounded-full font-medium
                                            @if($nbcLoan['risk_level'] === 'High Risk') bg-red-100 text-red-800
                                            @elseif($nbcLoan['risk_level'] === 'Medium Risk') bg-yellow-100 text-yellow-800
                                            @elseif($nbcLoan['risk_level'] === 'Low Risk') bg-green-100 text-green-800
                                            @else bg-gray-100 text-gray-800 @endif">
                                            {{ $nbcLoan['risk_level'] }}
                                        </span>
                                    </td>
                                    <td class="p-2 text-center">
                                        <div class="flex items-center justify-center">
                                            <input wire:model="selectedLoan" type="radio" name="selectedLoan"
                                                value="{{ $nbcLoan['id'] }}"
                                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded 
                                                          focus:ring-blue-500 dark:focus:ring-blue-600 
                                                          dark:ring-offset-gray-800 focus:ring-2 
                                                          dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                    </td>
                                </tr>
                                @endforeach
                            </tbody>
                        </table>
                    </div>

                    <!-- Loan Details Summary -->
                    @if(isset($nbcLoansData['selected_loan']) && $nbcLoansData['selected_loan'])
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-900 mb-2">Selected Loan Details</h4>
                        @php $selectedLoan = collect($nbcLoansData['loans'])->firstWhere('id', $nbcLoansData['selected_loan']); @endphp
                        @if($selectedLoan)
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div>
                                <span class="text-gray-600">Product:</span>
                                <span class="font-medium text-gray-900">{{ $selectedLoan['product_name'] }}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Balance:</span>
                                <span class="font-medium text-gray-900">{{ number_format($selectedLoan['account_balance'], 2) }} TZS</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Installment:</span>
                                <span class="font-medium text-gray-900">{{ number_format($selectedLoan['installment'], 2) }} TZS</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Loan Age:</span>
                                <span class="font-medium text-gray-900">{{ $selectedLoan['loan_age_days'] }} days</span>
                            </div>
                        </div>

                        <!-- TopUp Impact Warning -->
                        @if($loan->loan_type_2=="TopUp")
                        <div class="mt-3 p-2 bg-yellow-50 rounded border border-yellow-200">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="text-xs text-yellow-800">
                                    <strong>Top-Up Impact:</strong> {{ number_format($selectedLoan['account_balance'], 2) }} TZS will be deducted from your new loan amount.
                                </div>
                            </div>
                        </div>
                        @endif
                        @endif
                    </div>
                    @endif

                    @else
                    <div class="text-center py-8">
                        <div class="text-gray-500 text-sm">No NBC SACOSS loans found for this client</div>
                    </div>
                    @endif

                </div>
            </div>

            <hr class="boder-b-0 my-6" />

            <p for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400 mt-4">LOANS TO BE SETTLED</p>

            <div class="w-full bg-gray-50 rounded rounded-lg shadow-sm p-1 mb-4">

                @if(isset($settlementData['summary']))
                <div class="w-full bg-white rounded rounded-lg shadow-sm p-2">

                    <!-- Settlement Summary Dashboard -->
                    @php $summary = $settlementData['summary'] ?? []; @endphp
                    <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-blue-900">Settlement Summary</h3>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 text-xs font-medium rounded-full 
                                    @if($summary['status'] ?? '' === 'Active') bg-green-100 text-green-800
                                    @else bg-gray-100 text-gray-800 @endif">
                                    {{ $summary['status'] ?? 'No Settlements' }}
                                </span>
                                <button wire:click="$set('showSettlementForm', true)"
                                    class="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors">
                                    + Add Settlement
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div class="bg-white p-3 rounded-lg border border-blue-200">
                                <div class="text-2xl font-bold text-blue-900">{{ $summary['settlement_count'] ?? 0 }}</div>
                                <div class="text-xs text-blue-600">Total Settlements</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-blue-200">
                                <div class="text-2xl font-bold text-green-900">{{ number_format($summary['total_amount'] ?? 0, 2) }}</div>
                                <div class="text-xs text-green-600">Total Amount (TZS)</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-blue-200">
                                <div class="text-2xl font-bold text-purple-900">{{ number_format($summary['average_amount'] ?? 0, 2) }}</div>
                                <div class="text-xs text-purple-600">Average Amount (TZS)</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-blue-200">
                                <div class="text-2xl font-bold text-orange-900">{{ isset($summary['last_updated']) && $summary['last_updated'] ? \Carbon\Carbon::parse($summary['last_updated'])->format('M d') : 'N/A' }}</div>
                                <div class="text-xs text-orange-600">Last Updated</div>
                            </div>
                        </div>

                        <!-- Impact on Disbursement -->
                        @if(($summary['total_amount'] ?? 0) > 0)
                        <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h6 class="text-sm font-semibold text-yellow-900">Impact on Disbursement</h6>
                                    <p class="text-xs text-yellow-700">This amount will be deducted from the loan disbursement</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-yellow-900">-{{ number_format($summary['total_amount'] ?? 0, 2) }} TZS</div>
                                    <div class="text-xs text-yellow-600">Deduction</div>
                                </div>
                            </div>
                        </div>
                        @endif
                    </div>

                    <!-- Error Message -->
                    @if($errorMessage)
                    <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm text-red-800">{{ $errorMessage }}</span>
                        </div>
                    </div>
                    @endif

                    <!-- Add/Edit Settlement Form -->
                    @if($showSettlementForm)
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-900">
                                {{ $editingSettlementId ? 'Edit Settlement' : 'Add New Settlement' }}
                            </h4>
                            <button wire:click="cancelSettlementForm"
                                class="text-gray-500 hover:text-gray-700 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">
                                    Institution Name <span class="text-red-500">*</span>
                                </label>
                                <input wire:model="settlementForm.institution" type="text"
                                    class="w-full p-3 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="e.g., Commercial Bank, Microfinance Institution" />
                                @error('settlementForm.institution')
                                <span class="text-xs text-red-600 mt-1">{{ $message }}</span>
                                @enderror
                            </div>

                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">
                                    Account Number <span class="text-red-500">*</span>
                                </label>
                                <input wire:model="settlementForm.account" type="text"
                                    class="w-full p-3 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="Enter account number" />
                                @error('settlementForm.account')
                                <span class="text-xs text-red-600">{{ $message }}</span>
                                @enderror
                            </div>

                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">Settlement Amount (TZS) *</label>
                                <input wire:model="settlementForm.amount" type="number" step="0.01" min="0"
                                    class="w-full p-3 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="0.00" />
                                @error('settlementForm.amount')
                                <span class="text-xs text-red-600">{{ $message }}</span>
                                @enderror
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3 mt-4">
                            <button wire:click="cancelSettlementForm"
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:ring-2 focus:ring-gray-500">
                                Cancel
                            </button>
                            @if($editingSettlementId)
                            <button wire:click="updateSettlement"
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                                Update Settlement
                            </button>
                            @else
                            <button wire:click="addSettlement"
                                class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500">
                                Add Settlement
                            </button>
                            @endif
                        </div>
                    </div>
                    @endif

                    <!-- Existing Settlements -->
                    @if(isset($settlementData['settlements']) && count($settlementData['settlements']) > 0)
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-900">Existing Settlements</h4>

                        @foreach($settlementData['settlements'] as $settlement)
                        <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-shrink-0">
                                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                                <span class="text-blue-600 font-semibold">{{ $settlement['id'] }}</span>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-4">
                                                <div>
                                                    <h5 class="font-medium text-gray-900">{{ $settlement['institution'] }}</h5>
                                                    <p class="text-sm text-gray-500">Account: {{ $settlement['account'] }}</p>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg font-bold text-gray-900">{{ number_format($settlement['amount'], 2) }} TZS</div>
                                                    <div class="text-xs text-gray-500">
                                                        Updated: {{ \Carbon\Carbon::parse($settlement['updated_at'])->format('M d, Y H:i') }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button wire:click="editSettlement({{ $settlement['id'] }})"
                                    class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button wire:click="deleteSettlement({{ $settlement['id'] }})"
                                    onclick="return confirm('Are you sure you want to delete this settlement?')"
                                    class="p-2 text-red-600 hover:bg-red-100 rounded-lg">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        @endforeach
                    </div>
                    @endif
                </div>
                @else
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="text-gray-500 text-sm">No settlements found</div>
                    <div class="text-gray-400 text-xs mt-2">Click "Add Settlement" to create your first settlement</div>
                </div>
                @endif

                <!-- Settlement Summary -->
                @if(isset($settlementData['summary']) && $settlementData['summary']['total_amount'] > 0)
                <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                    <h4 class="text-sm font-semibold text-green-900 mb-2">Total Settlement Summary</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-green-700">Total Amount:</span>
                            <span class="font-semibold text-green-900">{{ number_format($settlementData['summary']['total_amount'], 2) }} TZS</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-green-700">Settlements:</span>
                            <span class="font-semibold text-green-900">{{ $settlementData['summary']['settlement_count'] }}</span>
                        </div>
                    </div>
                </div>
                @endif

            </div>



            <hr class="boder-b-0 my-6" />













































            <label for="stability" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400 mt-4">ASSESSMENT</label>
            <div id="stability" class="w-full bg-gray-50 rounded-lg shadow-sm p-1 mb-4">
                <div class="w-full bg-white rounded-lg shadow-sm p-4">

                    <!-- Assessment Header -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-indigo-900">Loan Assessment Summary</h3>
                                <p class="text-sm text-indigo-600 mt-1">Comprehensive loan evaluation and calculation</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-indigo-600">Assessment Date</div>
                                <div class="text-sm font-medium text-indigo-900">{{ now()->format('M d, Y') }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Income Assessment Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Income Assessment</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <label class="block text-xs font-medium text-gray-700 mb-2">Take Home Salary / Sales Proceeds</label>
                                <input wire:model="take_home" type="number" step="0.01" min="0"
                                    class="w-full p-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Enter take home amount">
                                <div class="text-xs text-gray-500 mt-1">From salary slip or business proceeds</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="text-xs font-medium text-gray-700 mb-1">Available for Loan Repayment</div>
                                <div class="text-lg font-bold text-green-600">
                                    {{ number_format($this->take_home ?? 0, 2) }} TZS
                                </div>
                                <div class="text-xs text-gray-500 mt-1">Monthly disposable income</div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Parameters Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Product Parameters</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-center">
                                <div class="text-xs text-blue-600 mb-1">Monthly Interest Rate</div>
                                <div class="text-lg font-bold text-blue-900">{{ number_format((float)$product->interest_value / 12, 2) }}%</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <div class="text-xs text-green-600 mb-1">Annual Interest Rate</div>
                                <div class="text-lg font-bold text-green-900">{{ number_format((float)$product->interest_value, 2) }}%</div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg text-center">
                                <div class="text-xs text-purple-600 mb-1">Max Term (Months)</div>
                                <div class="text-lg font-bold text-purple-900">{{ $product->max_term }}</div>
                            </div>
                            <div class="bg-orange-50 p-3 rounded-lg text-center">
                                <div class="text-xs text-orange-600 mb-1">Grace Period</div>
                                <div class="text-lg font-bold text-orange-900">
                                    {{ ($product->principle_grace_period === null || $product->principle_grace_period == "") ? 0 : $product->principle_grace_period }} Months
                                </div>
                            </div>
                        </div>
                    </div>

                    @php
                    // Initialize retirement date variables
                    $retirementDate = $member->retirement_date ?? now()->addYears(5)->format('Y-m-d');
                    $member->contract_end_date = "2025-06-11";

                    // Create DateTime objects for today and the retirement date
                    $today = new DateTime();
                    $retirementDateObj = new DateTime($retirementDate);
                    $contractEndDateObj = new DateTime($member->contract_end_date);

                    // Calculate the difference in months
                    $retirementInterval = $today->diff($retirementDateObj);
                    $monthsDifference = $retirementInterval->y * 12 + $retirementInterval->m;
                    $monthsDifference -= 3; // Subtract 3 months buffer

                    $contractInterval = $today->diff($contractEndDateObj);
                    $monthsDifferencex = $contractInterval->y * 12 + $contractInterval->m;
                    $monthsDifferencex -= 3; // Subtract 3 months buffer
                    // Prevent negative contract term
                    $monthsDifferencex = max(0, $monthsDifferencex);

                    // Initialize top-up amount if not set
                    $topUpAmount = $this->topUpAmount ?? 0;
                    $this->totalAmount = $this->totalAmount ?? 0;
                    @endphp

                    <!-- Term Calculation Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Repayment Term Calculation</h4>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-xs text-yellow-600 mb-1">Retirement Term</div>
                                    <div class="text-sm font-bold text-yellow-900">{{ $monthsDifference }} months</div>
                                </div>
                                <div>
                                    <div class="text-xs text-yellow-600 mb-1">Contract Term</div>
                                    <div class="text-sm font-bold text-yellow-900">{{ $monthsDifferencex }} months</div>
                                </div>
                                <div>
                                    <div class="text-xs text-yellow-600 mb-1">Product Max Term</div>
                                    <div class="text-sm font-bold text-yellow-900">{{ $product->max_term }} months</div>
                                </div>
                                <div>
                                    <div class="text-xs text-yellow-600 mb-1">Requested Term</div>
                                    <div class="text-sm font-bold text-yellow-900">{{ $this->tenure ?? 0 }} months</div>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-white rounded border border-yellow-300">
                                <label class="block text-xs font-medium text-gray-700 mb-2">Approved Repayment Term (Months)</label>
                                @php
                                // Use the min() function to find the smallest value, but ensure no negative values
                                $validTerms = array_filter([
                                $monthsDifference,
                                $monthsDifferencex,
                                $product->max_term,
                                $this->tenure ?? $product->max_term
                                ], function($term) {
                                return $term > 0;
                                });
                                $minValue = !empty($validTerms) ? min($validTerms) : $product->max_term;
                                @endphp
                                <input wire:model="approved_term" type="number" min="1" max="{{ $product->max_term }}"
                                    class="w-full p-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                                    value="{{ $minValue }}">
                                <div class="text-xs text-gray-500 mt-1">Maximum allowed: {{ $minValue }} months</div>
                            </div>
                        </div>
                    </div>

                    @php
                    // Calculate loan amounts and payments
                    $theInt = (float)$product->interest_value/100;
                    $loanAmt = 0;

                    if(isset($this->take_home) && isset($this->approved_term)) {
                    $loanAmt = calculateTotalLoanAmount($theInt, (float)$this->approved_term, (float)$this->take_home);
                    }

                    // Calculate the monthly interest rate
                    $monthlyInterestRate = $theInt / 12;

                    // The principal is the loan amount
                    $principal = (float)($this->approved_loan_value ?? 0);

                    $member_category = $member->member_category;
                    $dayOfMonth = DB::table('member_categories')->where('id', $member_category)->value('repayment_date');

                    // Calculate the first installment interest amount
                    $firstInstallmentInterestAmount = $this->calculateFirstInterestAmount($principal, $monthlyInterestRate, $dayOfMonth);

                    // Calculate EMI
                    $monthlyInstallment = 0;
                    if(isset($this->approved_loan_value) && isset($this->approved_term)) {
                    $monthlyInstallment = calculateEMI((float)$this->approved_loan_value, $monthlyInterestRate, (float)$this->approved_term);
                    $this->monthlyInstallmentValue = $monthlyInstallment;
                    }

                    // Loan calculation functions
                    function calculateTotalLoanAmount($interestRate, $tenure, $takeHome) {
                    // Convert the annual interest rate to a monthly interest rate
                    $monthlyInterestRate = $interestRate / 12;

                    // Calculate the present value (principal + interest) based on the installment amount
                    if ($monthlyInterestRate == 0 || $monthlyInterestRate < 0.000001) {
                        $presentValue=$takeHome * $tenure;
                        } else {
                        $presentValue=($takeHome * (1 - pow(1 + $monthlyInterestRate, -$tenure))) / $monthlyInterestRate;
                        }

                        // Round down to the nearest 10,000
                        return floor($presentValue / 10000) * 10000;
                        }

                        function calculateEMI($principal, $monthlyInterestRate, $tenure) {
                        if ($monthlyInterestRate==0 || $monthlyInterestRate < 0.000001) {
                        return $tenure> 0 ? $principal / $tenure : 0;
                        } else {
                        $denominator = pow(1 + $monthlyInterestRate, $tenure) - 1;
                        if ($denominator == 0 || $denominator < 0.000001) {
                            return $tenure> 0 ? $principal / $tenure : 0;
                            }
                            return ($principal * $monthlyInterestRate * pow(1 + $monthlyInterestRate, $tenure)) / $denominator;
                            }
                            }
                            @endphp

                            <!-- Loan Amount Limits Section -->
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Loan Amount Limits</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-blue-50 p-3 rounded-lg">
                                        <div class="text-xs text-blue-600 mb-1">Maximum Qualifying Amount</div>
                                        <div class="text-lg font-bold text-blue-900">{{ number_format($loanAmt, 2) }} TZS</div>
                                        <div class="text-xs text-blue-500 mt-1">Based on take home salary</div>
                                    </div>
                                    <div class="bg-green-50 p-3 rounded-lg">
                                        <div class="text-xs text-green-600 mb-1">Product Maximum</div>
                                        <div class="text-lg font-bold text-green-900">{{ number_format($product->principle_max_value, 2) }} TZS</div>
                                        <div class="text-xs text-green-500 mt-1">Product limit</div>
                                    </div>
                                    <div class="bg-purple-50 p-3 rounded-lg">
                                        <div class="text-xs text-purple-600 mb-1">Requested Amount</div>
                                        <div class="text-lg font-bold text-purple-900">
                                            @php
                                            if(isset($loan->loan_type_2) && $loan->loan_type_2 == "Restructuring") {
                                            $balance = DB::table('sub_accounts')->where('account_number', $loan->loan_account_number)->value('balance');
                                            $this->approved_loan_value = $balance;
                                            }
                                            @endphp
                                            <input wire:model="approved_loan_value" type="number" step="0.01" min="0"
                                                class="w-full p-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500"
                                                @if(isset($loan->loan_type_2) && $loan->loan_type_2 == "Restructuring") disabled @endif>
                                        </div>
                                        <div class="text-xs text-purple-500 mt-1">Capital amount requested</div>
                                    </div>
                                </div>
                            </div>

                            @if($this->isPhysicalCollateral ?? false)
                            <!-- Collateral Section -->
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Collateral Information</h4>
                                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <div class="text-xs text-orange-600 mb-1">Security Value (FSV)</div>
                                            <div class="text-lg font-bold text-orange-900">{{ number_format($this->collateral_value ?? 0, 2) }} TZS</div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-orange-600 mb-1">LTV Policy</div>
                                            <div class="text-lg font-bold text-orange-900">{{ $product->ltv }}%</div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-orange-600 mb-1">Forced Sale Value</div>
                                            <div class="text-lg font-bold text-orange-900">{{ number_format(($this->collateral_value ?? 0)*(70/100), 2) }} TZS</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @endif

                            <!-- Comprehensive Collateral Details Section -->
                            @php
                            $collateralDetails = $this->getCollateralDetails(session('currentloanID'));
                            @endphp
                            @if(!empty($collateralDetails))
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Collateral Details</h4>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <div class="space-y-4">
                                        @foreach($collateralDetails as $collateral)
                                        <div class="bg-white p-3 rounded-lg border border-blue-300">
                                            <div class="flex justify-between items-start mb-2">
                                                <div>
                                                    <h5 class="text-sm font-semibold text-blue-900 capitalize">{{ $collateral['type'] }} Collateral</h5>
                                                    <p class="text-xs text-blue-700">Guarantor Type: {{ ucfirst(str_replace('_', ' ', $collateral['guarantor_type'])) }}</p>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-lg font-bold text-blue-900">{{ number_format($collateral['amount'], 2) }} TZS</div>
                                                    <div class="text-xs text-blue-600">Locked: {{ number_format($collateral['locked_amount'], 2) }} TZS</div>
                                                </div>
                                            </div>

                                            @if(isset($collateral['account_number']))
                                            <!-- Financial Collateral Details -->
                                            <div class="grid grid-cols-2 gap-2 text-xs text-blue-800">
                                                <div class="flex justify-between">
                                                    <span>Account Number:</span>
                                                    <span class="font-medium">{{ $collateral['account_number'] }}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Account Balance:</span>
                                                    <span class="font-medium">{{ number_format($collateral['account_balance'], 2) }} TZS</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Available Amount:</span>
                                                    <span class="font-medium">{{ number_format($collateral['available_amount'], 2) }} TZS</span>
                                                </div>
                                            </div>
                                            @endif

                                            @if(isset($collateral['description']))
                                            <!-- Physical Collateral Details -->
                                            <div class="grid grid-cols-1 gap-2 text-xs text-blue-800 mt-2">
                                                <div class="flex justify-between">
                                                    <span>Description:</span>
                                                    <span class="font-medium">{{ $collateral['description'] }}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Location:</span>
                                                    <span class="font-medium">{{ $collateral['location'] }}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Owner:</span>
                                                    <span class="font-medium">{{ $collateral['owner_name'] }}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Value:</span>
                                                    <span class="font-medium">{{ number_format($collateral['value'], 2) }} TZS</span>
                                                </div>
                                            </div>
                                            @endif
                                        </div>
                                        @endforeach

                                        <!-- Summary -->
                                        <div class="bg-blue-100 p-3 rounded-lg border border-blue-300">
                                            <div class="flex justify-between items-center">
                                                <span class="text-sm font-semibold text-blue-900">Total Collateral Value:</span>
                                                <span class="text-lg font-bold text-blue-900">{{ number_format($this->collateral_value ?? 0, 2) }} TZS</span>
                                            </div>
                                            <div class="flex justify-between items-center mt-1">
                                                <span class="text-xs text-blue-700">Total Locked Amount:</span>
                                                <span class="text-sm font-medium text-blue-800">{{ number_format(collect($collateralDetails)->sum('locked_amount'), 2) }} TZS</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            @endif

                            @php
                            // Initialize Loan Schedule Service and generate schedule data
                            $loanId = Session::get('currentloanID');
                            $approvedTerm = $this->approved_term ?? $product->max_term;
                            $approvedLoanValue = $this->approved_loan_value ?? 0;

                            // Additional parameters for loan scheduling
                            $member_category = $member->member_category;
                            $dayOfMonth = DB::table('member_categories')->where('id', $member_category)->value('repayment_date');

                            $updatedPrinciple = (float)$approvedLoanValue;

                            $repaymentSchedule = new App\Services\LoanRepaymentSchedule(
                            $loanId,
                            $approvedTerm,
                            $updatedPrinciple,
                            $dayOfMonth,
                            $monthlyInterestRate*12,
                            $product->principle_grace_period,
                            $member->member_category
                            );

                            $disbursementDate = date('Y-m-d');
                            $data = $repaymentSchedule->generateSchedule($disbursementDate);
                            $schedule = $data['schedule'] ?? [];
                            $footer = $data['footer'] ?? [];
                            $graceData = $data['graceData'] ?? [['days' => 0, 'balance' => 0]];
                            @endphp

                            <!-- Charges and Insurance Section -->
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Charges & Insurance</h4>

                                <!-- First Interest -->
                                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ $graceData[0]['days'] }} Days First Interest (Deducted upfront)</div>
                                            <div class="text-xs text-gray-500">Initial interest calculation</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-gray-900">{{ number_format($graceData[0]['balance'], 2) }} TZS</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Charges -->
                                <div class="mb-4">
                                    <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <h5 class="text-sm font-medium text-red-900">Charges</h5>
                                            <div class="text-sm font-bold text-red-900">
                                                @php
                                                $totalCharges = 0;
                                                $approvedLoanValue = (float)($this->approved_loan_value ?? 0);
                                                if(isset($this->charges) && $approvedLoanValue > 0) {
                                                foreach($this->charges as $charge) {
                                                if($charge->value_type === "fixed") {
                                                $chargeAmount = $charge->value;
                                                $totalCharges += $chargeAmount;
                                                } else {
                                                $chargeAmount = $approvedLoanValue > 0 ? ($approvedLoanValue * $charge->value / 100) : 0;
                                                $totalCharges += $chargeAmount;
                                                }
                                                }
                                                }
                                                @endphp
                                                {{ number_format($totalCharges, 2) }} TZS
                                            </div>
                                        </div>
                                        @if(isset($this->charges))
                                        <div class="space-y-1">
                                            @foreach($this->charges as $charge)
                                            <div class="flex justify-between text-xs">
                                                <span class="text-red-700">{{ $charge->name }}</span>
                                                <span class="text-red-900">
                                                    @if($charge->value_type === "fixed")
                                                    {{ number_format($charge->value, 2) }} TZS
                                                    @else
                                                    @php
                                                    $chargeAmount = $approvedLoanValue > 0 ? ($approvedLoanValue * $charge->value / 100) : 0;
                                                    @endphp
                                                    {{ number_format($chargeAmount, 2) }} TZS
                                                    @endif
                                                </span>
                                            </div>
                                            @endforeach
                                        </div>
                                        @endif
                                    </div>
                                </div>

                                <!-- Insurance -->
                                <div class="mb-4">
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <h5 class="text-sm font-medium text-blue-900">Insurance</h5>
                                            <div class="text-sm font-bold text-blue-900">
                                                @php
                                                $totalInsurance = 0;
                                                if(isset($this->insurance_list) && $approvedLoanValue > 0) {
                                                foreach($this->insurance_list as $insurance) {
                                                if($insurance->value_type === "fixed") {
                                                $insuranceAmount = $insurance->value;
                                                $totalInsurance += $insuranceAmount;
                                                } else {
                                                $insuranceAmount = ($approvedLoanValue * $insurance->value / 100);
                                                $totalInsurance += $insuranceAmount;
                                                }
                                                }
                                                }
                                                @endphp
                                                {{ number_format($totalInsurance, 2) }} TZS
                                            </div>
                                        </div>
                                        @if(isset($this->insurance_list))
                                        <div class="space-y-1">
                                            @foreach($this->insurance_list as $insurance)
                                            <div class="flex justify-between text-xs">
                                                <span class="text-blue-700">{{ $insurance->name }} - {{ ucfirst($insurance->value_type) }}</span>
                                                <span class="text-blue-900">
                                                    @if($insurance->value_type === "fixed")
                                                    {{ number_format($insurance->value, 2) }} TZS
                                                    @else
                                                    {{ number_format($approvedLoanValue > 0 ? ($approvedLoanValue * $insurance->value / 100) : 0, 2) }} TZS
                                                    @endif
                                                </span>
                                            </div>
                                            @endforeach
                                        </div>
                                        @endif
                                    </div>
                                </div>
                            </div>





                            <hr class="boder-b-0 my-6" />

                            <!-- Comprehensive Deduction Impact Section -->
                            @php
                            // Calculate all deductions
                            $topUpAmount = 0;
                            if ($this->selectedLoan) {
                            $topUpLoan = DB::table('loans')->where('id', $this->selectedLoan)->first();
                            if ($topUpLoan) {
                            $topUpAmount = $topUpLoan->amount_to_be_credited ?? 0;
                            }
                            }

                            $closedLoanBalance = 0;
                            if (isset($this->selectedLoan) && isset($loan->loan_account_number)) {
                            $closedLoanBalance = DB::table('accounts')
                            ->where('account_number', $loan->loan_account_number)
                            ->value('balance') ?? 0;
                            }

                            $outsideSettlements = $settlementData['summary']['total_amount'] ?? 0;

                            $totalDeductions = $totalCharges + $totalInsurance + $firstInstallmentInterestAmount +
                            ($this->totalAmount ?? 0) + $closedLoanBalance + $topUpAmount;

                            $netDisbursement = (float)($this->approved_loan_value ?? 0) - $totalDeductions;
                            @endphp

                            @if($totalDeductions > 0)
                            <div class="mb-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Deduction Impact Analysis</h4>
                                <div class="bg-gradient-to-r from-red-50 to-orange-50 rounded-lg p-4 border border-red-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <h5 class="text-lg font-semibold text-red-900">Total Deductions Impact</h5>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-red-600">-{{ number_format($totalDeductions, 2) }} TZS</div>
                                            <div class="text-sm text-red-700">Total Deductions</div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Deductions Breakdown -->
                                        <div>
                                            <h6 class="text-sm font-semibold text-red-800 mb-3">Deductions Breakdown</h6>
                                            <div class="space-y-2">
                                                @if($totalCharges > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Charges & Fees:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($totalCharges, 2) }} TZS</span>
                                                </div>
                                                @endif
                                                @if($totalInsurance > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Insurance:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($totalInsurance, 2) }} TZS</span>
                                                </div>
                                                @endif
                                                @if($firstInstallmentInterestAmount > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">First Interest:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($firstInstallmentInterestAmount, 2) }} TZS</span>
                                                </div>
                                                @endif
                                                @if($topUpAmount > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Top-Up Loan Balance:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($topUpAmount, 2) }} TZS</span>
                                                </div>
                                                @endif
                                                @if($closedLoanBalance > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Closed Loan Balance:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($closedLoanBalance, 2) }} TZS</span>
                                                </div>
                                                @endif
                                                @if($outsideSettlements > 0)
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Outside Loan Settlements:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($outsideSettlements, 2) }} TZS</span>
                                                </div>
                                                @endif
                                            </div>
                                        </div>

                                        <!-- Final Calculation -->
                                        <div>
                                            <h6 class="text-sm font-semibold text-green-800 mb-3">Final Disbursement</h6>
                                            <div class="space-y-3">
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-gray-700">Approved Loan Amount:</span>
                                                    <span class="font-semibold text-gray-900">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span>
                                                </div>
                                                <div class="flex justify-between text-sm">
                                                    <span class="text-red-700">Total Deductions:</span>
                                                    <span class="font-semibold text-red-900">-{{ number_format($totalDeductions, 2) }} TZS</span>
                                                </div>
                                                <div class="border-t border-gray-300 pt-2">
                                                    <div class="flex justify-between">
                                                        <span class="text-lg font-semibold text-green-700">Net Disbursement:</span>
                                                        <span class="text-xl font-bold text-green-800">{{ number_format($netDisbursement, 2) }} TZS</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Warning if net disbursement is negative -->
                                            @if($netDisbursement < 0)
                                                <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                                <div class="flex items-center">
                                                    <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    <div>
                                                        <h6 class="text-sm font-semibold text-red-800">Warning: Negative Net Disbursement</h6>
                                                        <p class="text-sm text-red-700">The total deductions exceed the approved loan amount. Please review the loan parameters.</p>
                                                    </div>
                                                </div>
                                        </div>
                                        @endif
                                    </div>
                                </div>

                                <!-- Loan Statistics Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-blue-900">Total Payments</p>
                                                <p class="text-lg font-bold text-blue-700">{{ count($schedule) }}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-green-900">Monthly Payment</p>
                                                <p class="text-lg font-bold text-green-700">{{ number_format($monthlyInstallment ?? 0, 2) }} TZS</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-purple-900">Total Interest</p>
                                                <p class="text-lg font-bold text-purple-700">{{ number_format($footer['total_interest'] ?? 0, 2) }} TZS</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0">
                                                <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm font-medium text-orange-900">Total Repayment</p>
                                                <p class="text-lg font-bold text-orange-700">{{ number_format($footer['total_payment'] ?? 0, 2) }} TZS</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                            </div>



                </div>
                @endif









                <!-- Final Summary Section -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 border-b pb-2">Loan Summary</h4>
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h5 class="text-sm font-semibold text-green-900 mb-3">Repayment Details</h5>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Monthly Installment:</span>
                                        <span class="text-sm font-bold text-gray-900">{{ number_format($monthlyInstallment, 2) }} TZS</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Total Repayment:</span>
                                        <span class="text-sm font-bold text-gray-900">{{ number_format((float)$monthlyInstallment * (float)($this->approved_term ?? 0), 2) }} TZS</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Repayment Term:</span>
                                        <span class="text-sm font-bold text-gray-900">{{ $this->approved_term ?? 0 }} months</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h5 class="text-sm font-semibold text-blue-900 mb-3">Disbursement Details</h5>
                                <div class="space-y-2">
                                    @php
                                    $this->ClosedLoanBalance = 0;
                                    if(isset($this->selectedLoan) && isset($loan->loan_account_number)) {
                                    $this->ClosedLoanBalance = DB::table('sub_accounts')
                                    ->where('account_number', $loan->loan_account_number)
                                    ->value('balance') ?? 0;
                                    }
                                    @endphp
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Loan Amount:</span>
                                        <span class="text-sm font-bold text-gray-900">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Total Deductions:</span>
                                        <span class="text-sm font-bold text-red-600">
                                            {{ number_format(
                                        $totalCharges + $totalInsurance + $firstInstallmentInterestAmount + 
                                        ($this->totalAmount ?? 0) + ($this->ClosedLoanBalance ?? 0) + ($topUpAmount ?? 0), 
                                        2
                                    ) }} TZS
                                        </span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="text-sm font-semibold text-gray-900">Net Disbursement:</span>
                                        <span class="text-lg font-bold text-green-600">
                                            {{ number_format(
                                        (float)($this->approved_loan_value ?? 0) - $totalCharges - $totalInsurance - 
                                        $firstInstallmentInterestAmount - ($this->totalAmount ?? 0) - 
                                        ($this->ClosedLoanBalance ?? 0) - ($topUpAmount ?? 0), 
                                        2
                                    ) }} TZS
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>




        @php
        $amount_to_be_credited = (float)$this->approved_loan_value - $totalCharges - $firstInstallmentInterestAmount - $this->totalAmount;
        DB::table('loans')
        ->where('id', Session::get('currentloanID'))
        ->update(['amount_to_be_credited' => $amount_to_be_credited]);
        @endphp




        <hr class="boder-b-0 my-6" />

        <p for="stability3" class="block mb-2 mt-2 text-sm font-medium text-gray-900 dark:text-gray-400">LOAN REPAYMENT SCHEDULE</p>
        <div id="stability3" class="w-full bg-gray-50 rounded rounded-lg shadow-sm p-1">
            <div class="w-full bg-white rounded rounded-lg shadow-sm p-4">

                <!-- Schedule Summary Cards -->
                @if(isset($schedule) && count($schedule) > 0)
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-blue-900">Total Payments</p>
                                    <p class="text-lg font-bold text-blue-700">{{ count($schedule) }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-green-900">Monthly Payment</p>
                                    <p class="text-lg font-bold text-green-700">{{ number_format($monthlyInstallment ?? 0, 2) }} TZS</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-purple-900">Total Interest</p>
                                    <p class="text-lg font-bold text-purple-700">{{ number_format($footer['total_interest'] ?? 0, 2) }} TZS</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-orange-900">Total Repayment</p>
                                    <p class="text-lg font-bold text-orange-700">{{ number_format($footer['total_payment'] ?? 0, 2) }} TZS</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Repayment Progress</span>
                            <span class="text-sm text-gray-500">{{ $this->approved_term ?? 0 }} months</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                @endif

                <!-- Schedule Controls -->
                <div class="mb-4 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">Show:</label>
                            <select id="scheduleFilter" class="text-sm border border-gray-300 rounded-md px-3 py-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Installments</option>
                                <option value="first5">First 5</option>
                                <option value="last5">Last 5</option>
                                <option value="overdue">Overdue</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">Sort by:</label>
                            <select id="scheduleSort" class="text-sm border border-gray-300 rounded-md px-3 py-1 focus:ring-blue-500 focus:border-blue-500">
                                <option value="date">Date</option>
                                <option value="payment">Payment Amount</option>
                                <option value="balance">Balance</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2">
                        <button onclick="exportSchedule()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                        <button onclick="printSchedule()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>

                <!-- Enhanced Schedule Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto border-collapse bg-white rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">#</th>
                                <th class="text-left py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Due Date</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Opening Balance</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Payment</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Principal</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Interest</th>
                                <th class="text-right py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Closing Balance</th>
                                <th class="text-center py-3 px-4 text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            @forelse ($schedule as $index => $installment)
                            @php
                            $isOverdue = false;
                            $isCurrent = false;
                            $isFuture = false;

                            if (isset($installment['installment_date'])) {
                            $installmentDate = \Carbon\Carbon::parse($installment['installment_date']);
                            $today = \Carbon\Carbon::today();

                            if ($installmentDate->lt($today)) {
                            $isOverdue = true;
                            } elseif ($installmentDate->eq($today)) {
                            $isCurrent = true;
                            } else {
                            $isFuture = true;
                            }
                            }
                            @endphp
                            <tr class="hover:bg-gray-50 transition-colors duration-200 {{ $isOverdue ? 'bg-red-50' : ($isCurrent ? 'bg-yellow-50' : '') }}">
                                <td class="py-3 px-4 text-sm font-medium text-gray-900">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center text-xs font-semibold mr-2">
                                            {{ $index + 1 }}
                                        </span>
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900">
                                    <div class="flex flex-col">
                                        <span class="font-medium">{{ $installment['installment_date'] ?? '-' }}</span>
                                        @if($isOverdue)
                                        <span class="text-xs text-red-600">Overdue</span>
                                        @elseif($isCurrent)
                                        <span class="text-xs text-yellow-600">Due Today</span>
                                        @endif
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 text-right font-mono">
                                    {{ number_format((float)$installment['opening_balance'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 text-right font-mono font-semibold">
                                    {{ number_format((float)$installment['payment'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 text-right font-mono">
                                    {{ number_format((float)$installment['principal'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 text-right font-mono">
                                    {{ number_format((float)$installment['interest'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-900 text-right font-mono">
                                    {{ number_format((float)$installment['closing_balance'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-center">
                                    @if($isOverdue)
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                        </svg>
                                        Overdue
                                    </span>
                                    @elseif($isCurrent)
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                        Due Today
                                    </span>
                                    @else
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        Pending
                                    </span>
                                    @endif
                                </td>
                            </tr>
                            @empty
                            <tr>
                                <td colspan="8" class="py-8 text-center">
                                    <div class="flex flex-col items-center">
                                        <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                        <p class="text-gray-500 text-sm">No repayment schedule available.</p>
                                        <p class="text-gray-400 text-xs mt-1">Please complete the loan assessment to generate the schedule.</p>
                                    </div>
                                </td>
                            </tr>
                            @endforelse
                        </tbody>

                        <!-- Enhanced Footer with Totals -->
                        @if(isset($footer) && count($schedule) > 0)
                        <tfoot>
                            <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-t-2 border-gray-300">
                                <td colspan="3" class="py-3 px-4 text-sm font-semibold text-gray-900">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        Totals
                                    </div>
                                </td>
                                <td class="py-3 px-4 text-sm font-semibold text-gray-900 text-right font-mono">
                                    {{ number_format((float)$footer['total_payment'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm font-semibold text-gray-900 text-right font-mono">
                                    {{ number_format((float)$footer['total_principal'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm font-semibold text-gray-900 text-right font-mono">
                                    {{ number_format((float)$footer['total_interest'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-sm font-semibold text-gray-900 text-right font-mono">
                                    {{ number_format((float)$footer['final_closing_balance'] ?? 0, 2) }}
                                </td>
                                <td class="py-3 px-4 text-center">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ count($schedule) }} Installments
                                    </span>
                                </td>
                            </tr>
                        </tfoot>
                        @endif
                    </table>
                </div>

                <!-- Additional Information -->
                @if(isset($schedule) && count($schedule) > 0)
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">Payment Information</h4>
                        <div class="space-y-1 text-xs text-blue-800">
                            <div class="flex justify-between">
                                <span>Payment Frequency:</span>
                                <span class="font-medium">Monthly</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Payment Day:</span>
                                <span class="font-medium">{{ $dayOfMonth ?? 'N/A' }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Grace Period:</span>
                                <span class="font-medium">{{ $product->principle_grace_period ?? 0 }} months</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="text-sm font-semibold text-green-900 mb-2">Interest Details</h4>
                        <div class="space-y-1 text-xs text-green-800">
                            <div class="flex justify-between">
                                <span>Annual Rate:</span>
                                <span class="font-medium">{{ number_format((float)$product->interest_value, 2) }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Monthly Rate:</span>
                                <span class="font-medium">{{ number_format((float)$product->interest_value / 12, 4) }}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Interest:</span>
                                <span class="font-medium">{{ number_format($footer['total_interest'] ?? 0, 2) }} TZS</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="text-sm font-semibold text-purple-900 mb-2">Loan Summary</h4>
                        <div class="space-y-1 text-xs text-purple-800">
                            <div class="flex justify-between">
                                <span>Principal Amount:</span>
                                <span class="font-medium">{{ number_format($this->approved_loan_value ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Repayment:</span>
                                <span class="font-medium">{{ number_format($footer['total_payment'] ?? 0, 2) }} TZS</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Interest Cost:</span>
                                <span class="font-medium">
                                    @php
                                    $principalAmount = (float)($this->approved_loan_value ?? 0);
                                    $totalInterest = (float)($footer['total_interest'] ?? 0);
                                    $interestPercentage = $principalAmount > 0 ? ($totalInterest / $principalAmount) * 100 : 0;
                                    @endphp
                                    {{ number_format($interestPercentage, 2) }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                @endif

            </div>
        </div>











































    </div>


</div>

<!-- JavaScript for Schedule Functionality -->
<script>
    function exportSchedule() {
        // Implementation for exporting schedule to Excel/PDF
        alert('Export functionality will be implemented here');
    }

    function printSchedule() {
        // Implementation for printing schedule
        window.print();
    }

    // Add event listeners for filters
    document.addEventListener('DOMContentLoaded', function() {
        const filterSelect = document.getElementById('scheduleFilter');
        const sortSelect = document.getElementById('scheduleSort');

        if (filterSelect) {
            filterSelect.addEventListener('change', function() {
                // Implementation for filtering schedule
                console.log('Filter changed to:', this.value);
            });
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', function() {
                // Implementation for sorting schedule
                console.log('Sort changed to:', this.value);
            });
        }
    });
</script>

<!-- Assessment Completion JavaScript -->
<script>
    //document.addEventListener('DOMContentLoaded', function() {
    // Credit Score Gauge Implementation
    const canvas = document.getElementById('demo');
    if (canvas) {
        const ctx = canvas.getContext('2d');

        // Get credit score value from the page
        const creditScoreElement = document.querySelector('.credit-score-value');
        const creditScore = creditScoreElement ? parseInt(creditScoreElement.textContent) : 500;

        // Create gauge configuration
        const gaugeConfig = {
            angle: 0.15,
            lineWidth: 0.44,
            radiusScale: 1,
            pointer: {
                length: 0.6,
                strokeWidth: 0.035,
                color: '#000000'
            },
            limitMax: false,
            limitMin: false,
            colorStart: '#6FADCF',
            colorStop: '#8FC0DA',
            strokeColor: '#E0E0E0',
            generateGradient: true,
            highDpiSupport: true,
            percentColors: [
                [0.0, "#ff0000"],
                [0.50, "#f9c802"],
                [1.0, "#00ff00"]
            ],
            renderTicks: {
                divisions: 5,
                divWidth: 1.1,
                divLength: 0.7,
                divColor: '#333333',
                subDivisions: 3,
                subLength: 0.5,
                subWidth: 0.6,
                subColor: '#666666'
            }
        };

        // Create gauge
        const gauge = new Gauge(canvas).setOptions(gaugeConfig);

        // Set the credit score (normalized to 0-1 range, assuming max score is 1000)
        const normalizedScore = Math.min(creditScore / 1000, 1);
        gauge.maxValue = 1000;
        gauge.setMinValue(0);
        gauge.animationSpeed = 32;
        gauge.set(creditScore);

        // Update preview text
        const previewText = document.getElementById('preview-textfield');
        if (previewText) {
            previewText.textContent = `Credit Score: ${creditScore}`;
        }
    }

    // Listen for assessment field updates
    window.addEventListener('assessment-field-updated', function() {
        console.log('Assessment field updated, checking completion...');
    });

    // Listen for assessment completion check
    window.addEventListener('check-assessment-completion', function() {
        // Add a small delay to ensure database updates are complete
        setTimeout(function() {
            // Emit Livewire event to check completion
            if (typeof Livewire !== 'undefined') {
                Livewire.emit('checkAssessmentCompletion');
            }
        }, 500);
    });

    // Listen for tab completion events
    window.addEventListener('tabCompleted', function(event) {
        if (event.detail === 'assessment') {
            console.log('Assessment tab completed!');
            // You can add additional UI feedback here
        }
    });
    //});
</script>

<!-- Restructuring Loan Selection Section -->
@if($loan->loan_type_2=="Restructuring")
<p for="restructuring" class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-400">SELECT LOAN TO RESTRUCTURE</p>
<div id="restructuring" class="w-full bg-gray-50 rounded rounded-lg shadow-sm p-1 mb-4">
    <div class="w-full bg-white rounded rounded-lg shadow-sm p-2">

        <!-- Restructuring Instructions -->
        <div class="mb-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <h4 class="text-sm font-semibold text-purple-900">Restructuring Instructions</h4>
                    <p class="text-xs text-purple-700">Select an existing active loan to restructure. The loan will be set to PENDING status and returned to the initial assessment stage.</p>
                </div>
            </div>
        </div>

        <!-- Active Loans for Restructuring -->
        @php
        $activeLoans = DB::table('loans')
        ->where('client_number', $loan->client_number)
        ->where('status', 'ACTIVE')
        ->where('id', '!=', $loan->id) // Exclude current loan
        ->get();
        @endphp

        @if($activeLoans->count() > 0)
        <div class="overflow-x-auto">
            <table class="w-full text-xs">
                <thead>
                    <tr class="bg-gray-100 border-b border-gray-200">
                        <th class="text-left p-2 font-medium text-gray-700">Loan ID</th>
                        <th class="text-left p-2 font-medium text-gray-700">Product</th>
                        <th class="text-right p-2 font-medium text-gray-700">Original Amount</th>
                        <th class="text-right p-2 font-medium text-gray-700">Current Balance</th>
                        <th class="text-center p-2 font-medium text-gray-700">Term</th>
                        <th class="text-center p-2 font-medium text-gray-700">Select</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach($activeLoans as $activeLoan)
                    @php
                    $currentBalance = DB::table('accounts')
                    ->where('account_number', $activeLoan->loan_account_number)
                    ->value('balance') ?? 0;
                    @endphp
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-2">
                            <div class="font-medium text-gray-900">{{ $activeLoan->loan_id }}</div>
                            <div class="text-xs text-gray-500">Created: {{ \Carbon\Carbon::parse($activeLoan->created_at)->format('M d, Y') }}</div>
                        </td>
                        <td class="p-2">
                            <div class="font-medium text-gray-900">
                                @php
                                $product = DB::table('loan_sub_products')
                                ->where('sub_product_id', $activeLoan->loan_sub_product)
                                ->first();
                                @endphp
                                {{ $product->sub_product_name ?? 'Unknown Product' }}
                            </div>
                        </td>
                        <td class="p-2 text-right">
                            <div class="font-semibold text-gray-900">{{ number_format($activeLoan->principle, 2) }} TZS</div>
                        </td>
                        <td class="p-2 text-right">
                            <div class="font-semibold text-purple-900">{{ number_format($currentBalance, 2) }} TZS</div>
                            <div class="text-xs text-gray-500">{{ $activeLoan->loan_account_number }}</div>
                        </td>
                        <td class="p-2 text-center">
                            <div class="font-medium text-gray-900">{{ $activeLoan->tenure ?? 12 }} months</div>
                        </td>
                        <td class="p-2 text-center">
                            <div class="flex items-center justify-center">
                                <input wire:model="selectedLoan" type="radio" name="selectedLoan"
                                    value="{{ $activeLoan->id }}"
                                    class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded 
                                                        focus:ring-purple-500 dark:focus:ring-purple-600 
                                                        dark:ring-offset-gray-800 focus:ring-2 
                                                        dark:bg-gray-700 dark:border-gray-600">
                            </div>
                        </td>
                    </tr>
                    @endforeach
                </tbody>
            </table>
        </div>

        <!-- Selected Loan Details for Restructuring -->
        @if($selectedLoan)
        <div class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
            <h4 class="text-sm font-semibold text-purple-900 mb-2">Selected Loan for Restructuring</h4>
            @php
            $selectedActiveLoan = $activeLoans->firstWhere('id', $selectedLoan);
            $selectedCurrentBalance = DB::table('accounts')
            ->where('account_number', $selectedActiveLoan->loan_account_number)
            ->value('balance') ?? 0;
            @endphp
            @if($selectedActiveLoan)
            <div class="grid grid-cols-2 gap-4 text-xs">
                <div>
                    <span class="text-purple-600">Loan ID:</span>
                    <span class="font-medium text-purple-900">{{ $selectedActiveLoan->loan_id }}</span>
                </div>
                <div>
                    <span class="text-purple-600">Current Balance:</span>
                    <span class="font-medium text-purple-900">{{ number_format($selectedCurrentBalance, 2) }} TZS</span>
                </div>
                <div>
                    <span class="text-purple-600">Original Amount:</span>
                    <span class="font-medium text-purple-900">{{ number_format($selectedActiveLoan->principle, 2) }} TZS</span>
                </div>
                <div>
                    <span class="text-purple-600">Account:</span>
                    <span class="font-medium text-purple-900">{{ $selectedActiveLoan->loan_account_number }}</span>
                </div>
            </div>

            <!-- Restructuring Impact Warning -->
            <div class="mt-3 p-2 bg-yellow-50 rounded border border-yellow-200">
                <div class="flex items-center">
                    <svg class="w-4 h-4 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="text-xs text-yellow-800">
                        <strong>Restructuring Impact:</strong> The selected loan will be set to PENDING status and returned to the initial assessment stage.
                    </div>
                </div>
            </div>
            @endif
        </div>
        @endif

        @else
        <div class="text-center py-8">
            <div class="text-gray-500 text-sm">No active loans found for restructuring</div>
        </div>
        @endif

    </div>
</div>
@endif

</div>

</div>

</div>